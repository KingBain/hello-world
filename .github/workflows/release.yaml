name: Create Release

on:
  push:
    branches: [main]
    paths-ignore:
      - README.md

  schedule:
    - cron: '0 0 * * *'

  workflow_dispatch: {}

concurrency: release

jobs:
  # ------------------------------------------------------------
  # Job 1: Snapshot metadata
  # ------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      snapshot-date: ${{ steps.snapshot.outputs.date }}
      snapshot-epoch: ${{ steps.snapshot.outputs.epoch }}
    steps:
      - id: snapshot
        run: |
          echo "date=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "epoch=$(date +%s)" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------
  # Job 2: Build & push per-arch images
  # ------------------------------------------------------------
  build:
    name: Build & Push (${{ matrix.arch }})
    needs: setup
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            tag_suffix: amd64
          - arch: aarch64
            tag_suffix: arm64
          - arch: armv7
            tag_suffix: arm

    steps:
      - uses: actions/checkout@v6.0.1

      - uses: docker/setup-qemu-action@v3.7.0

      - uses: sigstore/cosign-installer@v4.0.0

      # --------------------------------------------------------
      # Build APKs (single arch)
      # --------------------------------------------------------
      - uses: chainguard-dev/actions/melange-build@v1.5.10
        with:
          sign-with-temporary-key: true
          signing-key-path: melange.rsa
          config: melange.yaml
          archs: ${{ matrix.arch }}

      # --------------------------------------------------------
      # Build OCI image (single arch)
      # --------------------------------------------------------
      - uses: chainguard-images/actions/apko-build@v1.0.11
        with:
          config: apko.yaml
          tag: ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-${{ matrix.tag_suffix }}
          keyring-append: melange.rsa.pub
          archs: ${{ matrix.arch }}
          source-date-epoch: ${{ needs.setup.outputs.snapshot-epoch }}

      # --------------------------------------------------------
      # Push image
      # --------------------------------------------------------
      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image
        run: |
          docker load < output.tar
          docker push ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-${{ matrix.tag_suffix }}

  # ------------------------------------------------------------
  # Job 3: Create & push multi-arch manifest
  # ------------------------------------------------------------
  manifest:
    name: Publish multi-arch manifest
    needs: build
    runs-on: ubuntu-latest

    permissions:
      packages: write
      id-token: write

    steps:
      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Create manifest
        run: |
          docker manifest create ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }} \
            ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-amd64 \
            ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-arm64 \
            ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-arm

          docker manifest annotate ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }} \
            ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}-arm \
            --os linux --arch arm --variant v7

          docker manifest push ghcr.io/${{ github.repository }}:${{ needs.setup.outputs.snapshot-date }}

  # ------------------------------------------------------------
  # Job 4: Generate README
  # ------------------------------------------------------------
  generate-readme:
    name: Generate README
    needs: manifest
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6.0.1

      - name: Get repo name
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - uses: chainguard-images/readme-generator@main
        with:
          repo: https://github.com/${{ github.repository }}
          name: ${{ env.REPO_NAME }}
          location: ghcr.io/${{ github.repository }}
          description: "Hello, world!"
          push-to-repo: true

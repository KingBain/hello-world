name: Create Release

on:
  push:
    branches: [main]
    paths-ignore:
      - README.md
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

concurrency: release

jobs:
  # ------------------------------------------------------------
  # Job 1: Snapshot metadata + normalized image repo
  # ------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      snapshot-date: ${{ steps.snapshot.outputs.date }}
      snapshot-epoch: ${{ steps.snapshot.outputs.epoch }}
      image-repo: ${{ steps.snapshot.outputs.image_repo }}
    steps:
      - id: snapshot
        run: |
          echo "date=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "epoch=$(date +%s)" >> $GITHUB_OUTPUT
          echo "image_repo=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------
  # Job 2: Build & push per-arch images
  # ------------------------------------------------------------
  build:
    name: Build & Push (${{ matrix.arch }})
    needs: setup
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            tag_suffix: amd64
          - arch: aarch64
            tag_suffix: arm64
          - arch: armv7
            tag_suffix: arm

    steps:
      - uses: actions/checkout@v6.0.1
      - uses: docker/setup-qemu-action@v3.7.0
      - uses: sigstore/cosign-installer@v4.0.0

      - uses: chainguard-dev/actions/melange-build@v1.5.10
        with:
          sign-with-temporary-key: true
          signing-key-path: melange.rsa
          config: melange.yaml
          archs: ${{ matrix.arch }}

      # FIX 1: Remove the suffix here. Apko adds the arch automatically.
      # This prevents "...-amd64-amd64"
      - uses: chainguard-images/actions/apko-build@v1.0.11
        with:
          config: apko.yaml
          tag: ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}
          keyring-append: melange.rsa.pub
          archs: ${{ matrix.arch }}
          source-date-epoch: ${{ needs.setup.outputs.snapshot-epoch }}

      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # FIX 2: Dynamic Retagging
      # 1. Load the image and grab the tag name Apko generated (e.g., ...-armv7)
      # 2. Retag it to the name defined in your matrix (e.g., ...-arm)
      # 3. Push the matrix name
      - name: Push image
        run: |
          # Load image and capture output
          LOAD_OUTPUT=$(docker load < output.tar)
          echo "$LOAD_OUTPUT"
          
          # Extract the loaded tag (Format: "Loaded image: repo:tag")
          LOADED_TAG=$(echo "$LOAD_OUTPUT" | grep "Loaded image" | cut -d' ' -f3)
          
          # Define the target tag based on your matrix
          TARGET_TAG="${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-${{ matrix.tag_suffix }}"
          
          # Retag and Push
          docker tag "$LOADED_TAG" "$TARGET_TAG"
          docker push "$TARGET_TAG"

  # ------------------------------------------------------------
  # Job 3: Create & push multi-arch manifest
  # ------------------------------------------------------------
  manifest:
    name: Publish multi-arch manifest
    needs: [setup, build]
    runs-on: ubuntu-latest

    permissions:
      packages: write
      id-token: write

    steps:
      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Create manifest
        run: |
          docker manifest create ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }} \
            ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-amd64 \
            ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-arm64 \
            ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-arm

          docker manifest annotate ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }} \
            ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-arm \
            --os linux --arch arm --variant v7

          docker manifest push ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}

  # ------------------------------------------------------------
  # Job 4: Generate README
  # ------------------------------------------------------------
  generate-readme:
    name: Generate README
    needs: [setup, manifest]
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6.0.1

      - name: Get repo name
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - uses: chainguard-images/readme-generator@main
        with:
          repo: https://github.com/${{ github.repository }}
          name: ${{ env.REPO_NAME }}
          location: ${{ needs.setup.outputs.image-repo }}
          description: "Hello, world!"
          push-to-repo: true
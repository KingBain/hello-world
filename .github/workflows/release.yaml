name: Create Release

on:
  push:
    branches: [main]
    paths-ignore:
      - README.md
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

concurrency: release

jobs:
  # ------------------------------------------------------------
  # Job 1: Setup - Define Metadata AND Arch list here
  # ------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      snapshot-date: ${{ steps.snapshot.outputs.date }}
      snapshot-epoch: ${{ steps.snapshot.outputs.epoch }}
      image-repo: ${{ steps.snapshot.outputs.image_repo }}
      # Define the suffixes here so we only change it in one place if we add more
      arch-suffixes: "amd64 arm64 arm"
    steps:
      - id: snapshot
        run: |
          echo "date=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "epoch=$(date +%s)" >> $GITHUB_OUTPUT
          echo "image_repo=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
          # We don't need to echo arch-suffixes to output because we hardcoded it in the yaml outputs above,
          # but if you wanted it dynamic you could echo it here.

  # ------------------------------------------------------------
  # Job 2: Build (Unchanged, but for context)
  # ------------------------------------------------------------
  build:
    name: Build & Push (${{ matrix.arch }})
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            tag_suffix: amd64
          - arch: aarch64
            tag_suffix: arm64
          - arch: armv7
            tag_suffix: arm
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
      - uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
      - uses: chainguard-dev/actions/melange-build@3e8a2a226fad9e1ecbf2d359b8a7697554a4ac6d # v1.5.10
        with:
          sign-with-temporary-key: true
          signing-key-path: melange.rsa
          config: melange.yaml
          archs: ${{ matrix.arch }}
      - uses: chainguard-images/actions/apko-build@95c64af473be476d6169619eb2f372e72b3a1562 # v1.0.11
        with:
          config: apko.yaml
          tag: ${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}
          keyring-append: melange.rsa.pub
          archs: ${{ matrix.arch }}
          source-date-epoch: ${{ needs.setup.outputs.snapshot-epoch }}
      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Push image
        run: |
          LOAD_OUTPUT=$(docker load < output.tar)
          LOADED_TAG=$(echo "$LOAD_OUTPUT" | grep "Loaded image" | cut -d' ' -f3)
          TARGET_TAG="${{ needs.setup.outputs.image-repo }}:${{ needs.setup.outputs.snapshot-date }}-${{ matrix.tag_suffix }}"
          docker tag "$LOADED_TAG" "$TARGET_TAG"
          docker push "$TARGET_TAG"

  # ------------------------------------------------------------
  # Job 3: Manifest - Dynamic Looping
  # ------------------------------------------------------------
  manifest:
    name: Publish multi-arch manifest
    needs: [setup, build]
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write

    steps:
      - uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Create and Push Manifests
        env:
          # Pull inputs from setup job
          REPO: ${{ needs.setup.outputs.image-repo }}
          DATE_TAG: ${{ needs.setup.outputs.snapshot-date }}
          SUFFIXES: ${{ needs.setup.outputs.arch-suffixes }} # "amd64 arm64 arm"
        run: |
          # 1. Construct the list of source images dynamically
          # Result example: "repo:date-amd64 repo:date-arm64 repo:date-arm"
          SOURCE_IMAGES=""
          for suffix in $SUFFIXES; do
            SOURCE_IMAGES="$SOURCE_IMAGES $REPO:$DATE_TAG-$suffix"
          done

          # 2. Define the target tags we want to create (Date AND Latest)
          TARGETS="$REPO:$DATE_TAG $REPO:latest"

          # 3. Loop through targets to create, annotate, and push
          for target in $TARGETS; do
            echo "Creating manifest for $target..."
            
            # Create the manifest
            # $SOURCE_IMAGES expands to the list of 3 images we built
            docker manifest create $target $SOURCE_IMAGES

            # Special Annotation for ARMv7
            # We explicitly check if 'arm' was in our suffixes list to ensure safety
            if [[ "$SUFFIXES" == *"arm"* ]]; then
               echo "Annotating armv7..."
               docker manifest annotate $target $REPO:$DATE_TAG-arm --os linux --arch arm --variant v7
            fi

            # Push
            docker manifest push $target
            cosign sign --yes "$target"
          done

  # ------------------------------------------------------------
  # Job 4: Generate README (Use the template method discussed)
  # ------------------------------------------------------------
  generate-readme:
    name: Generate README
    needs: [setup, manifest]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Generate README from template
        env:
          GITHUB_REPO: ${{ github.repository }}
          REPO_NAME: ${{ github.event.repository.name }}
          IMAGE_REPO: ${{ needs.setup.outputs.image-repo }}
          TAG: ${{ needs.setup.outputs.snapshot-date }}
          DESCRIPTION: "Hello, world!"
          WORKFLOW_URL: "${{ github.server_url }}/${{ github.repository }}/actions/workflows/release.yaml"
        run: envsubst < .github/README.tpl.md > README.md
      - uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7
        with:
          commit_message: "docs: update README for release ${{ needs.setup.outputs.snapshot-date }}"
          file_pattern: README.md